# -*- coding: utf-8 -*-
# æ¬¢è¿å„ä½æ¥åˆ°ã€ŒåŠ›æ‰£å˜‰å¹´åã€ï¼Œæ¥ä¸‹æ¥å°†ä¸ºå„ä½ä»‹ç»åœ¨æ´»åŠ¨ä¸­å¹¿å—å¥½è¯„çš„å¼¹ç æ¸¸æˆã€‚
#
# `N*M` å¤§å°çš„å¼¹ç ç›˜çš„åˆå§‹çŠ¶æ€ä¿¡æ¯è®°å½•äºä¸€ç»´å­—ç¬¦ä¸²å‹æ•°ç»„ `plate` ä¸­ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ä¸ºä»…ç”± `"O"`ã€`"W"`ã€`"E"`ã€`"."` ç»„
# æˆçš„å­—ç¬¦ä¸²ã€‚å…¶ä¸­ï¼š
# - `"O"` è¡¨ç¤ºå¼¹ç æ´ï¼ˆå¼¹ç åˆ°è¾¾åä¼šè½å…¥æ´ä¸­ï¼Œå¹¶åœæ­¢å‰è¿›ï¼‰ï¼›
# - `"W"` è¡¨ç¤ºé€†æ—¶é’ˆè½¬å‘å™¨ï¼ˆå¼¹ç ç»è¿‡æ—¶æ–¹å‘å°†é€†æ—¶é’ˆæ—‹è½¬ 90 åº¦ï¼‰ï¼›
# - `"E"` è¡¨ç¤ºé¡ºæ—¶é’ˆè½¬å‘å™¨ï¼ˆå¼¹ç ç»è¿‡æ—¶æ–¹å‘å°†é¡ºæ—¶é’ˆæ—‹è½¬ 90 åº¦ï¼‰ï¼›
# - `"."` è¡¨ç¤ºç©ºç™½åŒºåŸŸï¼ˆå¼¹ç å¯é€šè¡Œï¼‰ã€‚
#
# æ¸¸æˆè§„åˆ™è¦æ±‚ä»…èƒ½åœ¨è¾¹ç¼˜ä½ç½®çš„ **ç©ºç™½åŒºåŸŸ** å¤„ï¼ˆå¼¹ç ç›˜çš„å››è§’é™¤å¤–ï¼‰æ²¿ **ä¸è¾¹ç¼˜å‚ç›´** çš„æ–¹å‘æ‰“å…¥å¼¹ç ï¼Œå¹¶ä¸”æ‰“å…¥åçš„æ¯é¢—å¼¹ç æœ€å¤šèƒ½ **å‰è¿›** `
# num` æ­¥ã€‚è¯·è¿”å›ç¬¦åˆä¸Šè¿°è¦æ±‚ä¸”å¯ä»¥ä½¿å¼¹ç æœ€ç»ˆå…¥æ´çš„æ‰€æœ‰æ‰“å…¥ä½ç½®ã€‚ä½ å¯ä»¥ **æŒ‰ä»»æ„é¡ºåº** è¿”å›ç­”æ¡ˆã€‚
#
# **æ³¨æ„ï¼š**
# - è‹¥å¼¹ç å·²åˆ°è¾¾å¼¹ç ç›˜è¾¹ç¼˜å¹¶ä¸”ä»æ²¿ç€å‡ºç•Œæ–¹å‘ç»§ç»­å‰è¿›ï¼Œåˆ™å°†ç›´æ¥å‡ºç•Œã€‚
#
# **ç¤ºä¾‹ 1ï¼š**
#
# > è¾“å…¥ï¼š
# > `num = 4`
# > `plate = ["..E.",".EOW","..W."]`
# >
# > è¾“å‡ºï¼š`[[2,1]]`
# >
# > è§£é‡Šï¼š
# > åœ¨ `[2,1]` å¤„æ‰“å…¥å¼¹ç ï¼Œå¼¹ç å‰è¿› 1 æ­¥åé‡åˆ°è½¬å‘å™¨ï¼Œå‰è¿›æ–¹å‘é¡ºæ—¶é’ˆæ—‹è½¬ 90 åº¦ï¼Œå†å‰è¿› 1 æ­¥è¿›å…¥æ´ä¸­ã€‚
# > ![b054955158a99167b8d51da0e22a54da.gif](https://pic.leetcode-cn.com/16303926
# 49-BoQncz-b054955158a99167b8d51da0e22a54da.gif)
#
# **ç¤ºä¾‹ 2ï¼š**
#
# > è¾“å…¥ï¼š
# > `num = 5`
# > `plate = [".....","..E..",".WO..","....."]`
# >
# > è¾“å‡ºï¼š`[[0,1],[1,0],[2,4],[3,2]]`
# >
# > è§£é‡Šï¼š
# > åœ¨ `[0,1]` å¤„æ‰“å…¥å¼¹ç ï¼Œå¼¹ç å‰è¿› 2 æ­¥ï¼Œé‡åˆ°è½¬å‘å™¨åå‰è¿›æ–¹å‘é€†æ—¶é’ˆæ—‹è½¬ 90 åº¦ï¼Œå†å‰è¿› 1 æ­¥è¿›å…¥æ´ä¸­ã€‚
# > åœ¨ `[1,0]` å¤„æ‰“å…¥å¼¹ç ï¼Œå¼¹ç å‰è¿› 2 æ­¥ï¼Œé‡åˆ°è½¬å‘å™¨åå‰è¿›æ–¹å‘é¡ºæ—¶é’ˆæ—‹è½¬ 90 åº¦ï¼Œå†å‰è¿› 1 æ­¥è¿›å…¥æ´ä¸­ã€‚
# > åœ¨ `[2,4]` å¤„æ‰“å…¥å¼¹ç ï¼Œå¼¹ç å‰è¿› 2 æ­¥åè¿›å…¥æ´ä¸­ã€‚
# > åœ¨ `[3,2]` å¤„æ‰“å…¥å¼¹ç ï¼Œå¼¹ç å‰è¿› 1 æ­¥åè¿›å…¥æ´ä¸­ã€‚
# > ![b44e9963239ae368badf3d00b7563087.gif](https://pic.leetcode-cn.com/16303926
# 25-rckbdy-b44e9963239ae368badf3d00b7563087.gif)
#
# **ç¤ºä¾‹ 3ï¼š**
#
# > è¾“å…¥ï¼š
# > `num = 3`
# > `plate = [".....","....O","....O","....."]`
# >
# > è¾“å‡ºï¼š`[]`
# >
# > è§£é‡Šï¼š
# > ç”±äºå¼¹ç è¢«å‡»ä¸­ååªèƒ½å‰è¿› 3 æ­¥ï¼Œä¸”ä¸èƒ½åœ¨å¼¹ç æ´å’Œå¼¹ç ç›˜å››è§’æ‰“å…¥å¼¹ç ï¼Œæ•…ä¸å­˜åœ¨èƒ½è®©å¼¹ç å…¥æ´çš„æ‰“å…¥ä½ç½®ã€‚
#
# **æç¤ºï¼š**
# - `1 <= num <= 10^6`
# - `1 <= plate.length, plate[i].length <= 1000`
# - `plate[i][j]` ä»…åŒ…å« `"O"`ã€`"W"`ã€`"E"`ã€`"."`
#
#  Related Topics æ·±åº¦ä¼˜å…ˆæœç´¢ å¹¿åº¦ä¼˜å…ˆæœç´¢ å›¾ æ‹“æ‰‘æ’åº è®°å¿†åŒ–æœç´¢ æ•°ç»„ åŠ¨æ€è§„åˆ’ çŸ©é˜µ
#  ğŸ‘ 11 ğŸ‘ 0

from typing import List
from functools import lru_cache


# leetcode submit region begin(Prohibit modification and deletion)
class Solution:
    def ballGame(self, num: int, plate: List[str]) -> List[List[int]]:
        dirs = [(0, 1), (1, 0), (0, -1), (-1, 0)]
        R, C = len(plate), len(plate[0])

        @lru_cache(None)
        def check(r, c, dir, step):
            visted.add((r, c, dir))
            if plate[r][c] == 'O':
                return True
            if plate[r][c] == 'W':
                dir = (dir - 1) % 4
            elif plate[r][c] == 'E':
                dir = (dir + 1) % 4
            nr, nc = r + dirs[dir][0], c + dirs[dir][1]
            if 0 <= nr < R and 0 <= nc < C and step + 1 <= num and (nr, nc, dir) not in visted:
                return check(nr, nc, dir, step + 1)
            return False

        res = []
        for i in range(1, C - 1):
            visted = set()
            if plate[0][i] == '.' and check(0, i, 1, 0):
                res.append([0, i])
            visted = set()
            if plate[R - 1][i] == '.' and check(R - 1, i, 3, 0):
                res.append([R - 1, i])
        for i in range(1, R - 1):
            visted = set()
            if plate[i][0] == '.' and check(i, 0, 0, 0):
                res.append([i, 0])
            visted = set()
            if plate[i][C - 1] == '.' and check(i, C - 1, 2, 0):
                res.append([i, C - 1])
        return sorted(res)


# leetcode submit region end(Prohibit modification and deletion)
print(Solution().ballGame(
    1,
    ["...", ".O."]
))
