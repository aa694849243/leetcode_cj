# -*- coding: utf-8 -*-
import functools
from typing import List


# æŸè§£å¯†æ¸¸æˆä¸­ï¼Œæœ‰ä¸€ä¸ª N\*M çš„è¿·å®«ï¼Œè¿·å®«åœ°å½¢ä¼šéšæ—¶é—´å˜åŒ–è€Œæ”¹å˜ï¼Œè¿·å®«å‡ºå£ä¸€ç›´ä½äº `(n-1,m-1)` ä½ç½®ã€‚è¿·å®«å˜åŒ–è§„å¾‹è®°å½•äº `maze` ä¸­ï¼Œ`
# maze[i]` è¡¨ç¤º `i` æ—¶åˆ»è¿·å®«çš„åœ°å½¢çŠ¶æ€ï¼Œ`"."` è¡¨ç¤ºå¯é€šè¡Œç©ºåœ°ï¼Œ`"#"` è¡¨ç¤ºé™·é˜±ã€‚
#
# åœ°å½¢å›¾åˆå§‹çŠ¶æ€è®°ä½œ `maze[0]`ï¼Œæ­¤æ—¶å°åŠ›ä½äºèµ·ç‚¹ `(0,0)`ã€‚æ­¤åæ¯ä¸€æ—¶åˆ»å¯é€‰æ‹©å¾€ä¸Šã€ä¸‹ã€å·¦ã€å³å…¶ä¸€æ–¹å‘èµ°ä¸€æ­¥ï¼Œæˆ–è€…åœç•™åœ¨åŸåœ°ã€‚
#
# å°åŠ›èƒŒåŒ…æœ‰ä»¥ä¸‹ä¸¤ä¸ªé­”æ³•å·è½´ï¼ˆå·è½´ä½¿ç”¨ä¸€æ¬¡åæ¶ˆå¤±ï¼‰ï¼š
# + ä¸´æ—¶æ¶ˆé™¤æœ¯ï¼šå°†æŒ‡å®šä½ç½®åœ¨ä¸‹ä¸€ä¸ªæ—¶åˆ»å˜ä¸ºç©ºåœ°ï¼›
# + æ°¸ä¹…æ¶ˆé™¤æœ¯ï¼šå°†æŒ‡å®šä½ç½®æ°¸ä¹…å˜ä¸ºç©ºåœ°ã€‚
#
# è¯·åˆ¤æ–­åœ¨è¿·å®«å˜åŒ–ç»“æŸå‰ï¼ˆå«æœ€åæ—¶åˆ»ï¼‰ï¼Œå°åŠ›èƒ½å¦åœ¨ä¸ç»è¿‡ä»»æ„é™·é˜±çš„æƒ…å†µä¸‹åˆ°è¾¾è¿·å®«å‡ºå£å‘¢ï¼Ÿ
#
# **æ³¨æ„ï¼š è¾“å…¥æ•°æ®ä¿è¯èµ·ç‚¹å’Œç»ˆç‚¹åœ¨æ‰€æœ‰æ—¶åˆ»å‡ä¸ºç©ºåœ°ã€‚**
#
# **ç¤ºä¾‹ 1ï¼š**
# >è¾“å…¥ï¼š`maze = [[".#.","#.."],["...",".#."],[".##",".#."],["..#",".#."]]`
# >
# >è¾“å‡ºï¼š`true`
# >
# >è§£é‡Šï¼š
# ![maze.gif](https://pic.leetcode-cn.com/1615892239-SCIjyf-maze.gif)
#
#
# **ç¤ºä¾‹ 2ï¼š**
# >è¾“å…¥ï¼š`maze = [[".#.","..."],["...","..."]]`
# >
# >è¾“å‡ºï¼š`false`
# >
# >è§£é‡Šï¼šç”±äºæ—¶é—´ä¸å¤Ÿï¼Œå°åŠ›æ— æ³•åˆ°è¾¾ç»ˆç‚¹é€ƒå‡ºè¿·å®«ã€‚
#
# **ç¤ºä¾‹ 3ï¼š**
# >è¾“å…¥ï¼š`maze = [["...","...","..."],[".##","###","##."],[".##","###","##."],[".##
# ","###","##."],[".##","###","##."],[".##","###","##."],[".##","###","##."]]`
# >
# >è¾“å‡ºï¼š`false`
# >
# >è§£é‡Šï¼šç”±äºé“è·¯ä¸é€šï¼Œå°åŠ›æ— æ³•åˆ°è¾¾ç»ˆç‚¹é€ƒå‡ºè¿·å®«ã€‚
#
# **æç¤ºï¼š**
# - `1 <= maze.length <= 100`
# - `1 <= maze[i].length, maze[i][j].length <= 50`
# - `maze[i][j]` ä»…åŒ…å« `"."`ã€`"#"` Related Topics æ·±åº¦ä¼˜å…ˆæœç´¢ å¹¿åº¦ä¼˜å…ˆæœç´¢ æ•°ç»„ åŠ¨æ€è§„åˆ’ çŸ©é˜µ
#  ğŸ‘ 20 ğŸ‘ 0


class Solution:
    def escapeMaze(self, maze: List[List[str]]) -> bool:
        dtime = len(maze) - 1
        R, C = len(maze[0]), len(maze[0][0])
        dirs = [(0, 1), (0, -1), (-1, 0), (1, 0)]

        @functools.lru_cache(None)
        def dp(r, c, tmp, perm, time):
            if time > dtime:
                return False
            if time == dtime:
                return (r, c) == (R - 1, C - 1)
            if (r, c) == (R - 1, C - 1):
                return True
            matrix = maze[time + 1]
            ans = False
            for dr, dc in dirs:
                nr, nc = r + dr, c + dc
                if 0 <= nr < R and 0 <= nc < C:
                    if matrix[nr][nc] == '.':
                        ans = dp(nr, nc, tmp, perm=1 if perm == 1 else 0, time=time + 1)
                    if ans: #æ¯ä¸€æ­¥éƒ½åˆ¤æ–­ä¸‹ï¼Œè¿”å›trueäº†å°±ç›´æ¥ç»ˆæ­¢ï¼Œä¸è¦æµªè´¹æ—¶é—´
                        return True
                    if tmp:  # ä¸´æ—¶ç¬¦è¿˜æ²¡ç”¨
                        ans = dp(nr, nc, tmp - 1, perm=1 if perm == 1 else 0, time=time + 1)
                    if ans:
                        return True
                    if perm == 1:  # å¯¹ä¸‹ä¸€ä¸ªåœ°ç‚¹ä½¿ç”¨æ°¸ä¹…ç¬¦
                        ans = dp(nr, nc, tmp, 2, time + 1)
                    if ans:
                        return True
            if perm == 2 or maze[time + 1][r][c] == '.':  # è¯¥å¤„æ‹¥æœ‰æ°¸ä¹…é­”æ³•
                ans = dp(r, c, tmp, perm, time + 1)
            elif perm == 1 and maze[time + 1][r][c] == '#':  # å¯¹è¯¥å¤„ä½¿ç”¨æ°¸ä¹…é­”æ³•
                ans = dp(r, c, tmp, 2, time + 1)
            if ans:
                return True
            if tmp and maze[time+1][r][c] == '#':  # å¯¹è¯¥å¤„ä½¿ç”¨ä¸´æ—¶é­”æ³•
                ans = dp(r, c, tmp-1, perm=1 if perm == 1 else 0, time=time+1)
            return ans

        return dp(0,0,1,1,0)
Solution().escapeMaze([[".##..####",".#######."],["..######.","########."],[".#####.##",".#######."],[".######.#","####.###."],[".##.##..#",".#.#####."],[".###.####","##.#..##."],[".########","#######.."],[".#####.##","#.######."],[".########","###..#.#."],[".####.#.#","###..##.."],[".######.#","########."]])